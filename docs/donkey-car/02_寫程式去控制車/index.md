---
draft: true
---

# 寫程式去控制車

## 如何控制車

donkey car 目前控制車的方式是透過大腦(jetson nano 或 rpi)以 I2C 的協議跟 PCA9685 交互，PCA9685 是一個 16 路伺服馬達控制擴展板，ESC 的控制方式跟伺服馬達一樣，所以控制轉向的伺服馬達跟 ESC 都可以接到 PCA9685

## 可以不透過 PCA9685 嗎

我猜測是可以，因為控制轉向的伺服馬達跟 ESC 都接到 PCA9685，arduino 可以用 PWM 訊號去控制伺服馬達，那當然也可以控制 ESC，ESC 的部分我另外參考這個[影片](https://youtu.be/uOQk8SJso6Q)，影片中把控制原理講的很詳細，但馬達會拉比較多電流，所以供電方面是需要獨立開來，不要用 arduino 去供電，我的想法是用 ESC 上的 BEC 來供給馬達跟 arduino 的電源

因為這顆 ESC 是可以前進跟後退，影片中只提到單方向

待補充: 用 arduion 控制轉向的伺服馬達跟 ESC 的程式碼
待補充: 可以前進後退的 ESC 怎麼用 PWM

## 突然不能轉向了

就在我寫完 arduino 的程式也測試好可以控制轉向跟前進後退之後，我再測一次發現車子不能轉向了，於是我開始找問題，先把伺服馬達拆下來，單獨測試用 sweep 那個範例來測，發現到一定的角度就轉不過去了，上網查也有不少伺服馬達壞掉的文章，我把馬達拆開來研究，但也不知道怎麼修了，後續可以寫一篇文章介紹伺服馬達的內部構造跟原理，不過我有發現有一款常見的伺服馬達(MG996R)的尺寸跟這顆很像，扭力 13kg 也比目前這顆大，所以我訂一顆來換換看

待補充: ，續可以寫一篇文章介紹伺服馬達的內部構造跟原理

## 有可能是什麼原因呢

有可能是在測試的時候想要轉 0~180 度，也許因為裝在車子上沒辦法轉到那麼大的角度，所以硬要轉的情況燒壞了，但我的情況是到一個角度就有問題，燒壞的話應該是整個不能用吧，這個馬達是塑膠的齒輪，也許是齒輪壞了，但拆了之後齒輪也沒有發現缺角，但後續做實驗的話，先不要裝在車上，單獨測試馬達本身，不要給阻力，確定可以之後再固定到車上，角度也不要轉那麼大

## 更換轉向馬達

收到 MG996R 之後，上次已經學到教訓知道伺服馬達可能會被我弄壞，所以就先無負載去測試轉動的效果，裝到車上時把擺臂調整到適合的角度，不要用螺絲固定，把轉動角度縮小，可以轉向就好，不要轉那麼大，確定好了再鎖螺絲，MG996R 的尺寸跟本來的很接近，所以安裝也很順利，唯一有差的擺臂跟轉軸本來有鎖螺絲，但換這款如果鎖螺絲會太緊，就先不鎖了

## PCA9685

adafruit 有[PCA9685 的教學文章](https://learn.adafruit.com/16-channel-pwm-servo-driver/overview)介紹了怎麼使用這個控制板，arduino uno 跟 PCA9685 的接線與程式碼如下

既然可以用 arduino 透過 I2C 跟 PCA9685 交互，後續換成其他的單板電腦，同樣也能用 I2C 來使用這個控制板
